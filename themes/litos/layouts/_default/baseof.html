<!DOCTYPE html>
<html lang="{{ .Site.Language.Lang | default "en" }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ if .IsHome }}{{ .Site.Title }}{{ else }}{{ .Title }} | {{ .Site.Title }}{{ end }}</title>
    
    <!-- CRITICAL: Theme must be set BEFORE any styles to prevent flash -->
    <script>
        (function() {
            'use strict';
            var theme = localStorage.getItem('theme') || 'system';
            var isDark = false;
            
            if (theme === 'dark') {
                isDark = true;
            } else if (theme === 'system') {
                isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            }
            
            if (isDark) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
    
    <!-- Meta tags -->
    <meta name="description" content="{{ if .Description }}{{ .Description }}{{ else }}{{ .Site.Params.description }}{{ end }}">
    <meta name="author" content="{{ .Site.Params.author }}">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist+Mono&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <!-- 思源宋体 - 仅用于块引用 -->
    <link rel="preconnect" href="https://fonts.loli.net">
    <link href="https://fonts.loli.net/css2?family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Remix Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.css" rel="stylesheet">
    
    <!-- Styles -->
    {{ $scss := resources.Get "scss/main.scss" }}
    {{ $style := $scss | css.Sass | resources.Minify }}
    <link rel="stylesheet" href="{{ $style.RelPermalink }}">
    
    <!-- Status Badge CSS Variables -->
    {{ partial "status-badge-css.html" . }}
    
    <!-- Post ViewImage Styles -->
    {{ if .IsPage }}
    {{ $postViewImageCSS := resources.Get "css/post-view-image.css" }}
    {{ if $postViewImageCSS }}
    {{ $postViewImageStyle := $postViewImageCSS | resources.Minify }}
    <link rel="stylesheet" href="{{ $postViewImageStyle.RelPermalink }}">
    {{ end }}
    {{ end }}
    
    <!-- Main theme JavaScript -->
    {{ $js := resources.Get "js/theme.js" }}
    {{ $script := $js | resources.Minify }}
    <script src="{{ $script.RelPermalink }}" defer></script>
    
    <!-- Logo Animation JavaScript -->
    {{ $logoJS := resources.Get "js/logo-animation.js" }}
    {{ if $logoJS }}
    {{ $logoScript := $logoJS | resources.Minify }}
    <script src="{{ $logoScript.RelPermalink }}" defer></script>
    {{ end }}
    
    <!-- Roll Page JavaScript -->
    {{ $rollJS := resources.Get "js/roll.js" }}
    {{ if $rollJS }}
    {{ $rollScript := $rollJS | resources.Minify }}
    <script src="{{ $rollScript.RelPermalink }}" defer></script>
    {{ end }}
    
    <!-- Redirect Script -->
    {{ $redirectJS := resources.Get "js/redirect.js" }}
    {{ if $redirectJS }}
    {{ $redirectScript := $redirectJS | resources.Minify }}
    <script src="{{ $redirectScript.RelPermalink }}" defer></script>
    {{ end }}
    
    <!-- ViewImage for Post Pages -->
    {{ if .IsPage }}
    {{ $viewImageJS := resources.Get "js/view-image.min.js" }}
    {{ if $viewImageJS }}
    {{ $viewImageScript := $viewImageJS | resources.Minify }}
    <script src="{{ $viewImageScript.RelPermalink }}" defer></script>
    {{ end }}
    
    {{ $postViewImageJS := resources.Get "js/post-view-image.js" }}
    {{ if $postViewImageJS }}
    {{ $postViewImageScript := $postViewImageJS | resources.Minify }}
    <script src="{{ $postViewImageScript.RelPermalink }}" defer></script>
    {{ end }}
    {{ end }}
    
    <!-- TOC JavaScript -->
    {{ $tocJS := resources.Get "js/toc.js" }}
    {{ if $tocJS }}
    {{ $tocScript := $tocJS | resources.Minify }}
    <script src="{{ $tocScript.RelPermalink }}" defer></script>
    {{ end }}
    
    <!-- Alerts JavaScript -->
    {{ $alertsJS := resources.Get "js/alerts.js" }}
    {{ if $alertsJS }}
    {{ $alertsScript := $alertsJS | resources.Minify }}
    <script src="{{ $alertsScript.RelPermalink }}" defer></script>
    {{ end }}
    
    <!-- Theme Toggle JavaScript -->
    {{ $themeToggleJS := resources.Get "js/theme-toggle.js" }}
    {{ if $themeToggleJS }}
    {{ $themeToggleScript := $themeToggleJS | resources.Minify }}
    <script src="{{ $themeToggleScript.RelPermalink }}" defer></script>
    {{ end }}

    <!-- Umami Stats JavaScript for About Page -->
    {{ if or (eq .Type "about") (strings.Contains .RelPermalink "/about") }}
    {{ $umamiStatsJS := resources.Get "js/umami-stats.js" }}
    {{ if $umamiStatsJS }}
    {{ $umamiStatsScript := $umamiStatsJS | resources.Minify }}
    <script src="{{ $umamiStatsScript.RelPermalink }}" defer></script>
    {{ end }}
    {{ end }}
    
    <!-- Bookmark Page JavaScript -->
    {{ if or (eq .Type "bookmark") (strings.Contains .RelPermalink "/bookmark") }}
    {{ $bookmarkJS := resources.Get "js/bookmark.js" }}
    {{ if $bookmarkJS }}
    <!-- Pass Hugo configuration to JavaScript -->
    <script>
        window.siteConfig = {
            raindrop: {
                enable: {{ .Site.Params.raindrop.enable | default true }},
                api_url: "{{ .Site.Params.raindrop.api_url | default "https://api.raindrop.io/rest/v1/raindrops/0" }}",
                token: "{{ .Site.Params.raindrop.token | default "" }}"
            }
        };
        console.log('Hugo config passed to JavaScript:', window.siteConfig);
        console.log('Raindrop token available:', window.siteConfig.raindrop.token ? 'Yes' : 'No');
        
        // 确保配置在页面加载前可用
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM ready, siteConfig available:', window.siteConfig);
            console.log('Raindrop token on DOM ready:', window.siteConfig.raindrop.token ? 'Available' : 'Not available');
        });
    </script>
    {{ $bookmarkScript := $bookmarkJS | resources.Minify }}
    <script src="{{ $bookmarkScript.RelPermalink }}"></script>
    {{ end }}
    {{ end }}
      
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="{{ .Site.Title }}">
    <meta name="application-name" content="{{ .Site.Title }}">
    <meta name="msapplication-TileColor" content="#000000">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-192x192.png">
    <link rel="mask-icon" href="/icons/favicon.svg" color="#000000">
    
    <!-- RSS and Atom Feeds -->
    {{ with .OutputFormats.Get "rss" -}}
        {{ printf `<link rel="%s" type="%s" href="%s" title="%s RSS Feed" />` .Rel .MediaType.Type .Permalink $.Site.Title | safeHTML }}
    {{ end -}}
    {{ with .OutputFormats.Get "atom" -}}
        {{ printf `<link rel="%s" type="%s" href="%s" title="%s Atom Feed" />` .Rel .MediaType.Type .Permalink $.Site.Title | safeHTML }}
    {{ end -}}
    
    <!-- Umami Analytics -->
    {{ if .Site.Params.umami.enable }}
    <script async src="{{ .Site.Params.umami.script }}" data-website-id="{{ .Site.Params.umami.website_id }}"></script>
    {{ end }}
</head>
<body class="site-container">
    <!-- SVG symbols for icons -->
    <svg width="0" height="0" style="display: none;" xmlns="http://www.w3.org/2000/svg">
        <symbol id="star" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
        </symbol>
        <symbol id="moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </symbol>
        <symbol id="sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </symbol>
    </svg>

    {{ partial "header.html" . }}
    
    <main class="site-main">
        {{ block "main" . }}{{ end }}
    </main>
    
    <div class="line-container">
        {{ partial "line.html" . }}
    </div>
    
    {{ partial "footer.html" . }}
    
    <!-- PWA JavaScript -->
    {{ $pwaJS := resources.Get "js/pwa.js" }}
    {{ if $pwaJS }}
    {{ $pwaScript := $pwaJS | resources.Minify }}
    <script src="{{ $pwaScript.RelPermalink }}" defer></script>
    {{ end }}
    
    <!-- 离线状态检测 -->
    <script>
        // 离线状态检测
        function updateOnlineStatus() {
            const indicator = document.getElementById('offline-indicator');
            if (!navigator.onLine) {
                if (!indicator) {
                    const offlineHTML = '<div id="offline-indicator" class="offline-indicator show">You are currently offline</div>';
                    document.body.insertAdjacentHTML('afterbegin', offlineHTML);
                }
            } else {
                if (indicator) {
                    indicator.remove();
                }
            }
        }
        
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // 初始检查
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', updateOnlineStatus);
        } else {
            updateOnlineStatus();
        }
    </script>
</body>
</html>