name: Friend Links Management

# æ³¨æ„ï¼šæ­¤å·¥ä½œæµåº”è¯¥æ”¾åœ¨ç‹¬ç«‹çš„ Issues ä»“åº“ä¸­
# å¦‚æœä½ ä½¿ç”¨ç‹¬ç«‹ä»“åº“ç®¡ç†å‹é“¾ï¼Œè¯·å°†æ­¤æ–‡ä»¶å¤åˆ¶åˆ°é‚£ä¸ªä»“åº“çš„ .github/workflows/ ç›®å½•

on:
  issues:
    types: [closed, labeled, unlabeled]
  workflow_dispatch:

jobs:
  rebuild-on-friend-link-change:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'å‹æƒ…é“¾æ¥') || contains(github.event.issue.labels.*.name, 'friend-link')

    steps:
      - name: Check if friend link issue
        id: check
        run: |
          echo "Friend link issue detected: ${{ github.event.issue.title }}"
          echo "Action: ${{ github.event.action }}"
          echo "Labels: ${{ join(github.event.issue.labels.*.name, ', ') }}"

      - name: Trigger rebuild
        if: github.event.action == 'closed' && contains(github.event.issue.labels.*.name, 'å·²é€šè¿‡')
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.MAIN_REPO_TOKEN }}
          script: |
            // è§¦å‘ä¸»ç«™é‡æ–°æ„å»º
            console.log('Friend link approved, triggering main site rebuild...')

            // æ–¹æ³•1: è§¦å‘ä¸»ä»“åº“çš„ repository_dispatch äº‹ä»¶
            try {
              await github.rest.repos.createDispatchEvent({
                owner: '${{ secrets.MAIN_REPO_OWNER }}', // ä¸»ç«™ä»“åº“æ‰€æœ‰è€…
                repo: '${{ secrets.MAIN_REPO_NAME }}',   // ä¸»ç«™ä»“åº“å
                event_type: 'friend-link-updated'
              })
              console.log('Main site rebuild triggered successfully')
            } catch (error) {
              console.log('Failed to trigger main site rebuild:', error)
            }

            // æ–¹æ³•2: è°ƒç”¨éƒ¨ç½²æœåŠ¡çš„ webhookï¼ˆå¦‚æœä½¿ç”¨ Vercel/Netlifyï¼‰
            // const webhookUrl = '${{ secrets.DEPLOY_WEBHOOK_URL }}'
            // if (webhookUrl) {
            //   await fetch(webhookUrl, { method: 'POST' })
            // }

            // æ·»åŠ è¯„è®ºé€šçŸ¥
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'âœ… å‹æƒ…é“¾æ¥å·²é€šè¿‡å®¡æ ¸ï¼ç½‘ç«™å°†åœ¨ä¸‹æ¬¡æ„å»ºæ—¶æ›´æ–°å‹é“¾åˆ—è¡¨ã€‚æ„Ÿè°¢æ‚¨çš„ç”³è¯·ï¼'
            })

  auto-label-friend-link:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' && contains(github.event.issue.title, '[å‹é“¾]')

    steps:
      - name: Auto label friend link issues
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['å‹æƒ…é“¾æ¥', 'å¾…å®¡æ ¸']
            })

            // æ·»åŠ æ¬¢è¿è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ‘‹ æ„Ÿè°¢æ‚¨ç”³è¯·å‹æƒ…é“¾æ¥ï¼

æˆ‘ä¼šåœ¨ 1-3 ä¸ªå·¥ä½œæ—¥å†…å®¡æ ¸æ‚¨çš„ç”³è¯·ã€‚å®¡æ ¸é€šè¿‡åä¼šå…³é—­æ­¤ Issue å¹¶æ·»åŠ  "å·²é€šè¿‡" æ ‡ç­¾ï¼Œç½‘ç«™ä¼šåœ¨ä¸‹æ¬¡æ„å»ºæ—¶è‡ªåŠ¨æ›´æ–°å‹é“¾åˆ—è¡¨ã€‚

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶åœ¨æ­¤ Issue ä¸­ç•™è¨€ã€‚`
            })
