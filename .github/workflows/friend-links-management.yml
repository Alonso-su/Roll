name: Friend Links Management

on:
  issues:
    types: [opened, closed, labeled, unlabeled]
  workflow_dispatch:

jobs:
  # è‡ªåŠ¨å¤„ç†æ–°çš„å‹é“¾ç”³è¯·
  auto-process-new-application:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' && contains(github.event.issue.title, '[å‹é“¾]')

    steps:
      - name: Auto label and welcome
        uses: actions/github-script@v7
        with:
          script: |
            // æ·»åŠ æ ‡ç­¾
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['å‹æƒ…é“¾æ¥', 'å¾…å®¡æ ¸']
            })

            // æ·»åŠ æ¬¢è¿è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ‘‹ **æ„Ÿè°¢æ‚¨ç”³è¯·å‹æƒ…é“¾æ¥ï¼**

ğŸ” **å®¡æ ¸æµç¨‹ï¼š**
1. æˆ‘ä¼šåœ¨ 1-3 ä¸ªå·¥ä½œæ—¥å†…å®¡æ ¸æ‚¨çš„ç”³è¯·
2. å®¡æ ¸æœŸé—´å¯èƒ½ä¼šåœ¨æ­¤ Issue ä¸­è¯¢é—®ç›¸å…³é—®é¢˜
3. å®¡æ ¸é€šè¿‡åä¼šå…³é—­æ­¤ Issue å¹¶æ·»åŠ  \`å·²é€šè¿‡\` æ ‡ç­¾
4. ç½‘ç«™ä¼šåœ¨ä¸‹æ¬¡æ„å»ºæ—¶è‡ªåŠ¨æ›´æ–°å‹é“¾åˆ—è¡¨

ğŸ“‹ **å®¡æ ¸è¦ç‚¹ï¼š**
- ç½‘ç«™å†…å®¹è´¨é‡å’ŒåŸåˆ›æ€§
- ç½‘ç«™è®¿é—®ç¨³å®šæ€§å’ŒåŠ è½½é€Ÿåº¦
- æ˜¯å¦å·²æ·»åŠ æœ¬ç«™å‹é“¾
- ç½‘ç«™è®¾è®¡å’Œç”¨æˆ·ä½“éªŒ

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶åœ¨æ­¤ Issue ä¸­ç•™è¨€ã€‚æ„Ÿè°¢æ‚¨çš„è€å¿ƒç­‰å¾…ï¼ ğŸ‰`
            })

  # å¤„ç†å®¡æ ¸é€šè¿‡çš„å‹é“¾
  handle-approved-links:
    runs-on: ubuntu-latest
    if: github.event.action == 'closed' && contains(github.event.issue.labels.*.name, 'å·²é€šè¿‡')

    steps:
      - name: Notify approval and trigger rebuild
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.MAIN_REPO_TOKEN }}
          script: |
            console.log('Friend link approved, processing...')

            // æ·»åŠ é€šè¿‡è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ‰ **å‹æƒ…é“¾æ¥ç”³è¯·å·²é€šè¿‡ï¼**

âœ… æ‚¨çš„ç½‘ç«™å·²æˆåŠŸåŠ å…¥å‹æƒ…é“¾æ¥åˆ—è¡¨ï¼

ğŸ”„ **æ›´æ–°æ—¶é—´ï¼š** ç½‘ç«™å°†åœ¨ä¸‹æ¬¡æ„å»ºæ—¶è‡ªåŠ¨æ›´æ–°å‹é“¾åˆ—è¡¨ï¼Œé€šå¸¸åœ¨å‡ åˆ†é’Ÿå†…ç”Ÿæ•ˆã€‚

ğŸ”— **æŸ¥çœ‹å‹é“¾ï¼š** https://suus.me/roll

å†æ¬¡æ„Ÿè°¢æ‚¨çš„ç”³è¯·ï¼ŒæœŸå¾…ä¸æ‚¨çš„ç½‘ç«™å»ºç«‹é•¿æœŸçš„å‹å¥½å…³ç³»ï¼ ğŸ¤`
            })

            // è§¦å‘ä¸»ç«™é‡æ–°æ„å»º
            try {
              const mainRepoOwner = '${{ secrets.MAIN_REPO_OWNER }}'
              const mainRepoName = '${{ secrets.MAIN_REPO_NAME }}'

              if (mainRepoOwner && mainRepoName) {
                await github.rest.repos.createDispatchEvent({
                  owner: mainRepoOwner,
                  repo: mainRepoName,
                  event_type: 'friend-link-updated',
                  client_payload: {
                    issue_number: context.issue.number,
                    issue_title: context.payload.issue.title,
                    action: 'approved'
                  }
                })
                console.log('Main site rebuild triggered successfully')
              }
            } catch (error) {
              console.log('Failed to trigger main site rebuild:', error)
            }

  # å¤„ç†è¢«æ‹’ç»çš„å‹é“¾
  handle-rejected-links:
    runs-on: ubuntu-latest
    if: github.event.action == 'closed' && contains(github.event.issue.labels.*.name, 'å·²æ‹’ç»')

    steps:
      - name: Notify rejection
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ˜” **å¾ˆæŠ±æ­‰ï¼Œæ‚¨çš„å‹æƒ…é“¾æ¥ç”³è¯·æœªèƒ½é€šè¿‡å®¡æ ¸ã€‚**

ğŸ“‹ **å¸¸è§æ‹’ç»åŸå› ï¼š**
- ç½‘ç«™å†…å®¹ä¸ç¬¦åˆè¦æ±‚
- ç½‘ç«™è®¿é—®ä¸ç¨³å®šæˆ–åŠ è½½è¿‡æ…¢
- æœªæ·»åŠ æœ¬ç«™å‹é“¾
- ç½‘ç«™æ›´æ–°é¢‘ç‡è¿‡ä½

ğŸ’¡ **æ”¹è¿›å»ºè®®ï¼š**
å¦‚æœæ‚¨è®¤ä¸ºç½‘ç«™å·²ç»æ”¹è¿›ï¼Œæ¬¢è¿é‡æ–°ç”³è¯·ã€‚è¯·ç¡®ä¿ï¼š
1. ç½‘ç«™å†…å®¹ä¸°å¯Œä¸”æŒç»­æ›´æ–°
2. å·²æ­£ç¡®æ·»åŠ æœ¬ç«™å‹é“¾
3. ç½‘ç«™è®¿é—®ç¨³å®šä¸”åŠ è½½é€Ÿåº¦è‰¯å¥½

æ„Ÿè°¢æ‚¨çš„ç†è§£ï¼ ğŸ™`
            })

  # è‡ªåŠ¨æ ‡è®°è¿‡æœŸçš„ç”³è¯·
  mark-stale-applications:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Mark stale applications
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'å¾…å®¡æ ¸',
              state: 'open',
              sort: 'created',
              direction: 'asc'
            })

            const thirtyDaysAgo = new Date()
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)

            for (const issue of issues) {
              const createdAt = new Date(issue.created_at)
              if (createdAt < thirtyDaysAgo) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['è¿‡æœŸç”³è¯·']
                })

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: 'â° æ­¤ç”³è¯·å·²è¶…è¿‡ 30 å¤©æœªå¤„ç†ï¼Œæ ‡è®°ä¸ºè¿‡æœŸç”³è¯·ã€‚å¦‚ä»éœ€ç”³è¯·ï¼Œè¯·é‡æ–°æäº¤ã€‚'
                })
              }
            }
